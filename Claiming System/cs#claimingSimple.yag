{{/*
    MADE BY: sum#0117 (209208777365389312)
    REQUESTED BY: 𝑴𝒆𝒍𝒌 𝑻𝒆𝒓𝒕𝒋𝒊𝒆♡☘#0117 (441642976058277898)
    DESCRIPTION: This command is a startup for the claiming reaction system. It"s made to request an embed with reactions which listener will be in another file.
    RECOMMENDED TRIGGER: -claiming
    USAGE METHOD: -claiming <user>
    
    MIT LICENSE
    Copyright (c) 2022 sum
*/}}

{{/*CODE - DO NOT EDIT WITHOUT PROPER KNOWLEDGE*/}}
{{$helpDb:= or (dbGet 0 "help").Value sdict}}
{{$helpDb.Set .Cmd (sdict 
"description" "Generates the claim embed to manage user's claiming state. Further instructions inside the spawned embed."
"category" "cs"
)}}

{{$err:= "❌ You didn't provide any arguments for the execution of this command."}}
{{if and 
    .CmdArgs
    (eq (len .CmdArgs) 1)
}}
    {{$claimState:= ""}}
    {{$user:= userArg (index .CmdArgs 0)}}
    {{if $user}}
        {{$db:= or (dbGet 0 "partners").Value dict}}

        {{if ($userStatus:=$db.Get $user.ID)}}
            {{if not $userStatus.pending}}
                {{if ($memberExists:=getMember (toInt $userStatus.isBusy))}}
                    {{$claimState = print "claimed by " $memberExists.User.Mention}}
                {{else}}
                    {{$claimState = print "alone because their partner left the server."}}
                {{end}}
            {{end}}
        {{end}}
        {{$instructions:= printf  "This is the panel to the user %s!\n\nThey are currently %s.\nAccess their information using the reactions below:\n1️⃣ Get a DM with the current vows of the user.\n2️⃣ Propose Forbidden Claim\n3️⃣ Comment about this user." $user.Username (or $claimState "not claimed by anyone.")}}

        {{$embed:= sdict    
        "description" $instructions
        "color" (randInt 16777215)
        "author" (sdict 
            "name" "Claiming Reaction System"
            "icon_url" "https://i.imgur.com/65OznjD.png"
        )
        "footer" (sdict
            "text" (printf "Embed reaction command generated by %s" .User.Username)
            "icon_url" (.User.AvatarURL "1024")
        )
        "thumbnail" (sdict "url" ($user.AvatarURL "1024"))
        }}

        {{/*
        Reaction Database Handler
        This will create a temporary database to make the message accept reactions for 2 minutes. I don't feel like making the 2 min timer optional because that's not something people usually care about, but if you want to increase or decrease the listener's duration, just change the "120" in the dbSetExpire line.
        */}}
        {{$msg:= sendMessageRetID nil (cembed $embed)}}
        {{dbSetExpire .User.ID "reactionHandler" (sdict "msgID" $msg "targetUser" $user.ID) 120}}
        {{addMessageReactions nil $msg "1️⃣" "2️⃣" "3️⃣"}}
    {{else}}
        {{$err = print "❌ Invalid user provided."}}
        {{sendMessage nil $err}}
    {{end}}

{{else}}    
    {{sendMessage nil $err}}
{{end}}